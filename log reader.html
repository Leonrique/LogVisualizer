<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Visualizador de Logs</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #controls {
            margin-bottom: 10px;
        }

        #controls>* {
            margin-right: 10px;
        }

        table {
            width: 100%;
        }

        td {
            cursor: pointer;
            white-space: pre-wrap;
            word-break: break-word;
            max-width: 600px;
            /* ajuste conforme o layout desejado */
        }

        .duplicate {
            background-color: #ffff99;
        }

        .similar {
            background-color: #ffcccb;
        }
    </style>
</head>

<body>

    <h2>Visualizador de Logs</h2>
    <div id="controls">
        <input type="file" id="fileInput" accept=".txt">
        <button id="copyAllButton">Copiar todos os SQLs filtrados</button>
        <button id="highlightDuplicatesButton">Destacar Duplicados</button>
        <select id="similarityThreshold">
            <option value="0.7">70%</option>
            <option value="0.75">75%</option>
            <option value="0.8">80%</option>
            <option value="0.85">85%</option>
            <option value="0.9" selected>90%</option>
            <option value="0.95">95%</option>
            <option value="0.98">98%</option>
        </select>
        <button id="highlightSimilarButton">Destacar Quase Duplicados</button>
        <button id="filterDuplicatesButton">Filtrar Duplicados</button>
        <button id="filterSimilarButton">Filtrar Similares</button>
        <button id="resetFilterButton">Resetar Filtro</button>
    </div>

    <table id="logTable" class="display">
        <thead>
            <tr>
                <th>Sequência</th>
                <th>Data Hora</th>
                <th>Tipo Log</th>
                <th>SQL</th>
                <th>Tempo</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.6.2/js/dataTables.colReorder.min.js"></script>
    <script>
        let table;

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const decoder = new TextDecoder('iso-8859-1'); // ou 'windows-1252'
                const text = decoder.decode(e.target.result);
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                const tableData = [];

                lines.forEach((line, index) => {
                    const cells = line.split(' | ');
                    if (cells.length >= 2) {
                        const row = [
                            index + 1,
                            cells[0] || '', // Data Hora
                            cells[1] || '', // Tipo Log
                            cells[2] || '', // SQL
                            (cells[3] || '').replace('Tempo:', '').trim(), // Tempo
                            '' // Status (calculado depois)
                        ];
                        tableData.push(row);
                    }
                });

                const tbody = document.querySelector('#logTable tbody');
                tbody.innerHTML = '';
                tableData.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                if ($.fn.dataTable.isDataTable('#logTable')) {
                    $('#logTable').DataTable().destroy();
                }
                table = $('#logTable').DataTable({
                    pageLength: 800,
                    searching: true,
                    ordering: true,
                    order: [[0, 'asc']],
                    colReorder: true,
                    columnDefs: [
                        { targets: 0, searchable: false }
                    ]
                });

                $('#logTable tbody').off('dblclick').on('dblclick', 'td', function () {
                    const cellIndex = table.cell(this).index().column;
                    if (cellIndex === 3) {
                        const text = $(this).text();
                        navigator.clipboard.writeText(text).then(() => {
                            alert('SQL copiado para a área de transferência!');
                        });
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('copyAllButton').addEventListener('click', function () {
            if (!table) return;
            const rows = table.rows({ search: 'applied' }).nodes();
            const sqls = [];
            rows.each(function (row) {
                const cell = $(row).find('td').eq(3);
                if (cell.length) {
                    sqls.push(cell.text().trim());
                }
            });
            navigator.clipboard.writeText(sqls.join('\n\n')).then(() => {
                alert('Todos os SQLs filtrados foram copiados para a área de transferência!');
            });
        });

        document.getElementById('highlightDuplicatesButton').addEventListener('click', function () {
            if (!table) return;
            const countMap = {};
            const rows = table.rows({ search: 'applied' }).nodes();

            rows.each(function (row) {
                const cell = $(row).find('td').eq(3);
                const text = cell.text().trim();
                if (!countMap[text]) {
                    countMap[text] = [];
                }
                countMap[text].push(row);
            });

            for (const [text, rowList] of Object.entries(countMap)) {
                rowList.forEach(row => {
                    const count = rowList.length;
                    $(row).find('td').last()
                        .text(count > 1 ? `Duplicado ${count}x` : '')
                        .toggleClass('duplicate', count > 1);

                    // Armazena a contagem em uma coluna oculta
                    $(row).data('duplicateCount', count);
                });
            }
        });

        function quickSimilarity(a, b) {
            if (!a || !b) return 0;
            const lenA = a.length;
            const lenB = b.length;
            if (Math.abs(lenA - lenB) > Math.max(lenA, lenB) * 0.2) {
                return 0;
            }

            const wordsA = new Set(a.toLowerCase().split(/\s+/));
            const wordsB = new Set(b.toLowerCase().split(/\s+/));
            const intersection = [...wordsA].filter(w => wordsB.has(w));
            const union = new Set([...wordsA, ...wordsB]);
            return intersection.length / union.size;
        }

        document.getElementById('highlightSimilarButton').addEventListener('click', function () {
            if (!table) return;

            // Limpar destaques anteriores
            table.rows().every(function () {
                const node = this.node();
                $(node).find('td').last().text('').removeClass('similar');
                $(node).data('similarCount', 0); // Resetar contagem
            });

            const threshold = parseFloat(document.getElementById('similarityThreshold').value);
            const sqls = [];
            const rows = [];
            const lineNumbers = [];

            table.rows({ search: 'applied' }).every(function () {
                const node = this.node();
                const text = $(node).find('td').eq(3).text().trim();
                const lineNumber = $(node).find('td').eq(0).text().trim();
                sqls.push(text);
                rows.push(node);
                lineNumbers.push(lineNumber);
            });

            for (let i = 0; i < sqls.length; i++) {
                let similarCount = 0;
                for (let j = 0; j < sqls.length; j++) {
                    if (i !== j && quickSimilarity(sqls[i], sqls[j]) >= threshold) {
                        similarCount++;
                        const similarText = `Quase Duplicado com linha(s): ${lineNumbers[j]}`;
                        $(rows[i]).find('td').last().text(similarText).addClass('similar');
                    }
                }
                // Armazena a contagem em uma coluna oculta
                $(rows[i]).data('similarCount', similarCount);
            }
        });

        document.getElementById('filterDuplicatesButton').addEventListener('click', function () {
            if (!table) return;

            // Identificar duplicados
            document.getElementById('highlightDuplicatesButton').click();

            // Ordenar por contagem de duplicados (decrescente)
            const rows = table.rows({ search: 'applied' }).nodes();
            const sortedRows = Array.from(rows).sort((a, b) => {
                const countA = $(a).data('duplicateCount') || 0;
                const countB = $(b).data('duplicateCount') || 0;
                return countB - countA;
            });

            // Reordenar as linhas na tabela
            sortedRows.forEach(row => $(row).appendTo('#logTable tbody'));

            // Filtrar linhas duplicadas
            sortedRows.forEach(row => {
                const isDuplicate = $(row).find('td').last().hasClass('duplicate');
                $(row).toggle(isDuplicate);
            });
        });

        document.getElementById('filterSimilarButton').addEventListener('click', function () {
            if (!table) return;

            // Identificar similares
            document.getElementById('highlightSimilarButton').click();

            // Ordenar por contagem de similares (decrescente)
            const rows = table.rows({ search: 'applied' }).nodes();
            const sortedRows = Array.from(rows).sort((a, b) => {
                const countA = $(a).data('similarCount') || 0;
                const countB = $(b).data('similarCount') || 0;
                return countB - countA;
            });

            // Reordenar as linhas na tabela
            sortedRows.forEach(row => $(row).appendTo('#logTable tbody'));

            // Filtrar linhas similares
            sortedRows.forEach(row => {
                const isSimilar = $(row).find('td').last().hasClass('similar');
                $(row).toggle(isSimilar);
            });
        });

        // Botão para resetar o filtro e mostrar todas as linhas
        document.getElementById('resetFilterButton').addEventListener('click', function () {
            if (!table) return;

            // Mostrar todas as linhas
            table.rows().every(function () {
                const node = this.node();
                $(node).show(); // Exibe todas as linhas

                // Remover estilos e textos aplicados para duplicidade e similaridade
                $(node).find('td').last().text('').removeClass('duplicate similar');
            });
        });
    </script>

</body>

</html>